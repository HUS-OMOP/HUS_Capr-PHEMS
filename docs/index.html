<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cohort Definition Application Programming • Capr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Cohort Definition Application Programming">
<meta property="og:description" content="Provides a programming language for defining OHDSI cohort definitions in R to use in studies for Observational 
    Health Data Sciences and Informatics (OHDSI). The functions in Capr allow for the programmatic creation of 
    OHDSI concept sets and cohorts that can be serialized to Atlas/CIRCE-BE compatible json files or to OHDSI-SQL. 
    Capr functions can be used to create, save, and load component parts to a cohort definition allowing 
    R programmers to easily reuse cohort logic. Capr provides tools to create a large number of OHDSI cohorts 
    programmatically while also helping bridge the gap between human readable descriptions of clinical phenotypes 
    and their computational implmentation. ">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">Capr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/Capr-conceptSets.html">Working with Concept Sets in Capr</a>
    </li>
    <li>
      <a href="articles/Examples.html">Cohort Definition Examples</a>
    </li>
    <li>
      <a href="articles/Using-Capr.html">Using Capr</a>
    </li>
    <li>
      <a href="articles/capr_design.html">Capr Design Guide and Roadmap</a>
    </li>
    <li>
      <a href="articles/capr_templates.html">Capr for Templating Cohort Definitions</a>
    </li>
  </ul>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://ohdsi.github.io/Hades" class="external-link">hadesLogo</a>
</li>
<li>
  <a href="https://github.com/OHDSI/Capr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">

<div class="section level1">
<div class="page-header"><h1 id="capr-">Capr <a href="https://ohdsi.github.io/Capr/" class="external-link"><img src="reference/figures/logo.png" align="right" height="90"></a>
<a class="anchor" aria-label="anchor" href="#capr-"></a>
</h1></div>
<!-- badges: start -->

<!-- badges: end -->
<p>Capr is part of <a href="https://ohdsi.github.io/Hades/" class="external-link">HADES</a></p>
</div>
<div class="section level1">
<h1 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h1>
<p>The goal of Capr, pronounced ‘kay-pr’ like the edible flower, is to provide a language for expressing OHDSI Cohort definitions in R code. OHDSI defines a cohort as “a set of persons who satisfy one or more inclusion criteria for a duration of time” and provides a standardized approach for defining them (Circe-be). Capr exposes the standardized approach to cohort building through a programmatic interface in R which is particularly helpful when creating a large number of similar cohorts. Capr version 2 introduces a new user interface designed for readability with the goal that Capr code being a human readable description of a cohort while also being executable on an OMOP Common Data Model.</p>
<p>Learn more about the OHDSI approach to cohort building in the <a href="https://ohdsi.github.io/TheBookOfOhdsi/Cohorts.html" class="external-link">cohorts chapter of the Book of OHDSI.</a></p>
</div>
<div class="section level1">
<h1 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h1>
<p>Capr can be installed via:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("Capr")</span></span></code></pre></div>
<p>Users can install the current development version of Capr from <a href="https://github.com/" class="external-link">GitHub</a> with:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("devtools")</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"ohdsi/Capr"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level1">
<h1 id="how-to-use">How to Use<a class="anchor" aria-label="anchor" href="#how-to-use"></a>
</h1>
<div class="section level2">
<h2 id="examples">Examples<a class="anchor" aria-label="anchor" href="#examples"></a>
</h2>
<p>Capr uses many defaults that match the defaults in Atlas. Creating a simple cohort is a single line of code. As an example we will define a cohort of new users of diclofenac described in the <a href="https://ohdsi.github.io/TheBookOfOhdsi/SuggestedAnswers.html#Cohortsanswers" class="external-link">Book of OHDSI.</a></p>
<div class="section level3">
<h3 id="simple-diclofenac-cohort">Simple diclofenac cohort<a class="anchor" aria-label="anchor" href="#simple-diclofenac-cohort"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ohdsi.github.io/Capr" class="external-link">Capr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define concepts sets with cs()</span></span>
<span><span class="va">diclofenac</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cs.html">cs</a></span><span class="op">(</span><span class="fu"><a href="reference/cs.html">descendants</a></span><span class="op">(</span><span class="fl">1124300</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ch</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cohort.html">cohort</a></span><span class="op">(</span></span>
<span>  entry <span class="op">=</span> <span class="fu"><a href="reference/entry.html">entry</a></span><span class="op">(</span><span class="fu"><a href="reference/drugEra.html">drugEra</a></span><span class="op">(</span><span class="va">diclofenac</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ch</span></span>
<span><span class="co">#&gt; Formal class 'Cohort' [package "Capr"] with 4 slots</span></span>
<span><span class="co">#&gt;   ..@ entry    :Formal class 'CohortEntry' [package "Capr"] with 5 slots</span></span>
<span><span class="co">#&gt;   ..@ attrition:Formal class 'CohortAttrition' [package "Capr"] with 2 slots</span></span>
<span><span class="co">#&gt;   ..@ exit     :Formal class 'CohortExit' [package "Capr"] with 2 slots</span></span>
<span><span class="co">#&gt;   ..@ era      :Formal class 'CohortEra' [package "Capr"] with 3 slots</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="adding-more-complexity">Adding more complexity<a class="anchor" aria-label="anchor" href="#adding-more-complexity"></a>
</h3>
<p>We can make more complex cohorts by adding a window of continuous observation and a custom cohort exit. The following information was added to the diclofenac cohort:</p>
<ul>
<li>Ages 16 or older</li>
<li>With at least 365 days of continuous observation prior to exposure</li>
<li>With cohort exit defined as discontinuation of exposure (allowing for a 30-day gap)</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diclofenac</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cs.html">cs</a></span><span class="op">(</span><span class="fu"><a href="reference/cs.html">descendants</a></span><span class="op">(</span><span class="fl">1124300</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ch</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cohort.html">cohort</a></span><span class="op">(</span></span>
<span>  entry <span class="op">=</span> <span class="fu"><a href="reference/entry.html">entry</a></span><span class="op">(</span><span class="fu"><a href="reference/drugEra.html">drugEra</a></span><span class="op">(</span><span class="va">diclofenac</span>, <span class="fu"><a href="reference/age.html">age</a></span><span class="op">(</span><span class="fu"><a href="reference/gte.html">gte</a></span><span class="op">(</span><span class="fl">16</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                observationWindow <span class="op">=</span> <span class="fu"><a href="reference/continuousObservation.html">continuousObservation</a></span><span class="op">(</span><span class="op">-</span><span class="fl">365L</span>, <span class="fl">0L</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  exit <span class="op">=</span> <span class="fu"><a href="reference/exit.html">exit</a></span><span class="op">(</span><span class="fu"><a href="reference/drugExit.html">drugExit</a></span><span class="op">(</span><span class="va">diclofenac</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ch</span></span>
<span><span class="co">#&gt; Formal class 'Cohort' [package "Capr"] with 4 slots</span></span>
<span><span class="co">#&gt;   ..@ entry    :Formal class 'CohortEntry' [package "Capr"] with 5 slots</span></span>
<span><span class="co">#&gt;   ..@ attrition:Formal class 'CohortAttrition' [package "Capr"] with 2 slots</span></span>
<span><span class="co">#&gt;   ..@ exit     :Formal class 'CohortExit' [package "Capr"] with 2 slots</span></span>
<span><span class="co">#&gt;   ..@ era      :Formal class 'CohortEra' [package "Capr"] with 3 slots</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="adding-cohort-attrition">Adding cohort attrition<a class="anchor" aria-label="anchor" href="#adding-cohort-attrition"></a>
</h3>
<p>Users can also add attrition to the cohort by specifying inclusion and exclusion criteria to modify the cohort entry. The following exclusion criteria were added to the diclofenac cohort:</p>
<ul>
<li>Without prior exposure to any NSAID (Non-Steroidal Anti-Inflammatory Drug)</li>
<li>Without prior diagnosis of cancer</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diclofenac</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cs.html">cs</a></span><span class="op">(</span><span class="fu"><a href="reference/cs.html">descendants</a></span><span class="op">(</span><span class="fl">1124300</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"diclofenac"</span><span class="op">)</span></span>
<span><span class="va">nsaid</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cs.html">cs</a></span><span class="op">(</span><span class="fu"><a href="reference/cs.html">descendants</a></span><span class="op">(</span><span class="fl">21603933</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"nsaid"</span><span class="op">)</span></span>
<span><span class="va">cancer</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cs.html">cs</a></span><span class="op">(</span><span class="fu"><a href="reference/cs.html">descendants</a></span><span class="op">(</span><span class="fl">443392</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"cancer"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ch</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cohort.html">cohort</a></span><span class="op">(</span></span>
<span>  entry <span class="op">=</span> <span class="fu"><a href="reference/entry.html">entry</a></span><span class="op">(</span><span class="fu"><a href="reference/drugEra.html">drugEra</a></span><span class="op">(</span><span class="va">diclofenac</span>, <span class="fu"><a href="reference/age.html">age</a></span><span class="op">(</span><span class="fu"><a href="reference/gte.html">gte</a></span><span class="op">(</span><span class="fl">16</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                observationWindow <span class="op">=</span> <span class="fu"><a href="reference/continuousObservation.html">continuousObservation</a></span><span class="op">(</span><span class="op">-</span><span class="fl">365L</span>, <span class="fl">0L</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  attrition <span class="op">=</span> <span class="fu"><a href="reference/attrition.html">attrition</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="reference/withAll.html">withAll</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="reference/exactly.html">exactly</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="reference/drug.html">drug</a></span><span class="op">(</span><span class="va">nsaid</span><span class="op">)</span>, <span class="fu"><a href="reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span>, index <span class="op">=</span> <span class="st">"startDate"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="reference/exactly.html">exactly</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="reference/condition.html">condition</a></span><span class="op">(</span><span class="va">cancer</span><span class="op">)</span>, <span class="fu"><a href="reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span>, index <span class="op">=</span> <span class="st">"startDate"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  exit <span class="op">=</span> <span class="fu"><a href="reference/exit.html">exit</a></span><span class="op">(</span></span>
<span>    endStrategy <span class="op">=</span> <span class="fu"><a href="reference/drugExit.html">drugExit</a></span><span class="op">(</span><span class="va">diclofenac</span>, persistenceWindow <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ch</span></span>
<span><span class="co">#&gt; Formal class 'Cohort' [package "Capr"] with 4 slots</span></span>
<span><span class="co">#&gt;   ..@ entry    :Formal class 'CohortEntry' [package "Capr"] with 5 slots</span></span>
<span><span class="co">#&gt;   ..@ attrition:Formal class 'CohortAttrition' [package "Capr"] with 2 slots</span></span>
<span><span class="co">#&gt;   ..@ exit     :Formal class 'CohortExit' [package "Capr"] with 2 slots</span></span>
<span><span class="co">#&gt;   ..@ era      :Formal class 'CohortEra' [package "Capr"] with 3 slots</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="save-cohort-as-json">Save cohort as JSON<a class="anchor" aria-label="anchor" href="#save-cohort-as-json"></a>
</h2>
<p>OHDSI standard cohorts are represented as json files and can be copy and pasted into Atlas.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"diclofenacCohort.json"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="reference/writeCohort.html">writeCohort</a></span><span class="op">(</span><span class="va">ch</span>, <span class="va">path</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_file.html" class="external-link">read_file</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;   "ConceptSets": [</span></span>
<span><span class="co">#&gt;     {</span></span>
<span><span class="co">#&gt;       "id": 0,</span></span>
<span><span class="co">#&gt;       "name": "diclofenac",</span></span>
<span><span class="co">#&gt;       "expression": {</span></span>
<span><span class="co">#&gt; </span></span></code></pre></div>
<div class="section level3">
<h3 id="fill-in-missing-concept-set-details">Fill in missing concept set details<a class="anchor" aria-label="anchor" href="#fill-in-missing-concept-set-details"></a>
</h3>
<p>Users can build valid cohorts with minimal concept information, only supplying a concept id and name. The example below shows the minimal concept set input for Capr.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">diclofenac</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cs.html">cs</a></span><span class="op">(</span><span class="fu"><a href="reference/cs.html">descendants</a></span><span class="op">(</span><span class="fl">1124300</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"diclofenac"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu">as.json</span><span class="op">(</span><span class="va">diclofenac</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;   "id": "11d012608fce118593830a3039042e56",</span></span>
<span><span class="co">#&gt;   "name": "diclofenac",</span></span>
<span><span class="co">#&gt;   "expression": {</span></span>
<span><span class="co">#&gt;     "items": [</span></span>
<span><span class="co">#&gt;       {</span></span>
<span><span class="co">#&gt;         "concept": {</span></span>
<span><span class="co">#&gt;           "CONCEPT_ID": 1124300,</span></span>
<span><span class="co">#&gt;           "CONCEPT_NAME": "",</span></span>
<span><span class="co">#&gt;           "STANDARD_CONCEPT": "",</span></span>
<span><span class="co">#&gt;           "STANDARD_CONCEPT_CAPTION": "",</span></span>
<span><span class="co">#&gt;           "INVALID_REASON": "",</span></span>
<span><span class="co">#&gt;           "INVALID_REASON_CAPTION": "",</span></span>
<span><span class="co">#&gt;           "CONCEPT_CODE": "",</span></span>
<span><span class="co">#&gt;           "DOMAIN_ID": "",</span></span>
<span><span class="co">#&gt;           "VOCABULARY_ID": "",</span></span>
<span><span class="co">#&gt;           "CONCEPT_CLASS_ID": ""</span></span>
<span><span class="co">#&gt;         },</span></span>
<span><span class="co">#&gt;         "isExcluded": false,</span></span>
<span><span class="co">#&gt;         "includeDescendants": true,</span></span>
<span><span class="co">#&gt;         "includeMapped": false</span></span>
<span><span class="co">#&gt;       }</span></span>
<span><span class="co">#&gt;     ]</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="co">#&gt; }</span></span></code></pre></div>
<p>However, when saving cohorts it is helpful to fill in the concept details. This requires a live connection to an OMOP CDM database that includes the vocabularies used in the cohort definition.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/connect.html" class="external-link">connect</a></span><span class="op">(</span><span class="fu">Eunomia</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Eunomia/man/getEunomiaConnectionDetails.html" class="external-link">getEunomiaConnectionDetails</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">diclofenac</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/getConceptSetDetails.html">getConceptSetDetails</a></span><span class="op">(</span><span class="va">diclofenac</span>, <span class="va">con</span>, vocabularyDatabaseSchema <span class="op">=</span> <span class="st">"main"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu">as.json</span><span class="op">(</span><span class="va">diclofenac</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;   "id": "11d012608fce118593830a3039042e56",</span></span>
<span><span class="co">#&gt;   "name": "diclofenac",</span></span>
<span><span class="co">#&gt;   "expression": {</span></span>
<span><span class="co">#&gt;     "items": [</span></span>
<span><span class="co">#&gt;       {</span></span>
<span><span class="co">#&gt;         "concept": {</span></span>
<span><span class="co">#&gt;           "CONCEPT_ID": 1124300,</span></span>
<span><span class="co">#&gt;           "CONCEPT_NAME": "Diclofenac",</span></span>
<span><span class="co">#&gt;           "STANDARD_CONCEPT": "S",</span></span>
<span><span class="co">#&gt;           "STANDARD_CONCEPT_CAPTION": "Standard",</span></span>
<span><span class="co">#&gt;           "INVALID_REASON": "V",</span></span>
<span><span class="co">#&gt;           "INVALID_REASON_CAPTION": "Valid",</span></span>
<span><span class="co">#&gt;           "CONCEPT_CODE": "3355",</span></span>
<span><span class="co">#&gt;           "DOMAIN_ID": "Drug",</span></span>
<span><span class="co">#&gt;           "VOCABULARY_ID": "RxNorm",</span></span>
<span><span class="co">#&gt;           "CONCEPT_CLASS_ID": "Ingredient"</span></span>
<span><span class="co">#&gt;         },</span></span>
<span><span class="co">#&gt;         "isExcluded": false,</span></span>
<span><span class="co">#&gt;         "includeDescendants": true,</span></span>
<span><span class="co">#&gt;         "includeMapped": false</span></span>
<span><span class="co">#&gt;       }</span></span>
<span><span class="co">#&gt;     ]</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="co">#&gt; }</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="generating-capr-cohorts">Generating Capr Cohorts<a class="anchor" aria-label="anchor" href="#generating-capr-cohorts"></a>
</h3>
<p>Once a Capr cohort has been constructed, the user can generate this cohort definition on an OMOP CDM connection. It is suggested to use <a href="https://github.com/OHDSI/CohortGenerator" class="external-link">CohortGenerator</a> and <a href="https://github.com/OHDSI/CirceR" class="external-link">CirceR</a> to generate Capr cohorts on a database.</p>
</div>
</div>
<div class="section level2">
<h2 id="building-capr-templates">Building Capr Templates<a class="anchor" aria-label="anchor" href="#building-capr-templates"></a>
</h2>
<p>A Capr cohort template is a function that always returns a Capr cohort. It can accept arguments that can be used to parameterize any part of a cohort definition. Capr cohort templates are the recommended approach for building large numbers of similar cohorts in R.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># A Capr cohort template is a function that returns a cohort</span></span>
<span><span class="va">drugEraTemplate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ingredientConceptId</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">drugConceptSet</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cs.html">cs</a></span><span class="op">(</span><span class="fu"><a href="reference/cs.html">descendants</a></span><span class="op">(</span><span class="va">ingredientConceptId</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="reference/cohort.html">cohort</a></span><span class="op">(</span></span>
<span>    entry <span class="op">=</span> <span class="fu"><a href="reference/entry.html">entry</a></span><span class="op">(</span><span class="fu"><a href="reference/drugEra.html">drugEra</a></span><span class="op">(</span><span class="va">drugConceptSet</span>, <span class="fu"><a href="reference/age.html">age</a></span><span class="op">(</span><span class="fu"><a href="reference/gte.html">gte</a></span><span class="op">(</span><span class="fl">16</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                  observationWindow <span class="op">=</span> <span class="fu"><a href="reference/continuousObservation.html">continuousObservation</a></span><span class="op">(</span><span class="op">-</span><span class="fl">365L</span>, <span class="fl">0L</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    exit <span class="op">=</span> <span class="fu"><a href="reference/exit.html">exit</a></span><span class="op">(</span><span class="fu"><a href="reference/drugExit.html">drugExit</a></span><span class="op">(</span><span class="va">drugConceptSet</span>, persistenceWindow <span class="op">=</span> <span class="fl">30</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a cohort for every single ingredient</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, </span>
<span>                      <span class="st">"Select * from concept where concept_class_id = 'Ingredient'"</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">concept_id</span>, <span class="va">concept_name</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>capr_cohort <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">concept_id</span>, <span class="va">drugEraTemplate</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cohort_json <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_chr</a></span><span class="op">(</span><span class="va">capr_cohort</span>, <span class="va">as.json</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span></span>
<span><span class="co">#&gt; # A tibble: 91 × 4</span></span>
<span><span class="co">#&gt;    concept_id concept_name    capr_cohort cohort_json                           </span></span>
<span><span class="co">#&gt;         &lt;dbl&gt; &lt;chr&gt;           &lt;list&gt;      &lt;chr&gt;                                 </span></span>
<span><span class="co">#&gt;  1    1557272 Alendronate     &lt;Cohort&gt;    "{\n  \"ConceptSets\": [\n    {\n    …</span></span>
<span><span class="co">#&gt;  2     708298 Midazolam       &lt;Cohort&gt;    "{\n  \"ConceptSets\": [\n    {\n    …</span></span>
<span><span class="co">#&gt;  3     701322 Memantine       &lt;Cohort&gt;    "{\n  \"ConceptSets\": [\n    {\n    …</span></span>
<span><span class="co">#&gt;  4     723013 Diazepam        &lt;Cohort&gt;    "{\n  \"ConceptSets\": [\n    {\n    …</span></span>
<span><span class="co">#&gt;  5    1129625 Diphenhydramine &lt;Cohort&gt;    "{\n  \"ConceptSets\": [\n    {\n    …</span></span>
<span><span class="co">#&gt;  6    1149196 Cetirizine      &lt;Cohort&gt;    "{\n  \"ConceptSets\": [\n    {\n    …</span></span>
<span><span class="co">#&gt;  7    1149380 fluticasone     &lt;Cohort&gt;    "{\n  \"ConceptSets\": [\n    {\n    …</span></span>
<span><span class="co">#&gt;  8    1150770 Astemizole      &lt;Cohort&gt;    "{\n  \"ConceptSets\": [\n    {\n    …</span></span>
<span><span class="co">#&gt;  9    1150836 Terfenadine     &lt;Cohort&gt;    "{\n  \"ConceptSets\": [\n    {\n    …</span></span>
<span><span class="co">#&gt; 10    1124300 Diclofenac      &lt;Cohort&gt;    "{\n  \"ConceptSets\": [\n    {\n    …</span></span>
<span><span class="co">#&gt; # … with 81 more rows</span></span></code></pre></div>
<p>The capr_cohort column of the dataframe is a list of Capr cohort object. The cohort_json column contains the json specifications for each cohort.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/disconnect.html" class="external-link">disconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level1">
<h1 id="user-documentation">User Documentation<a class="anchor" aria-label="anchor" href="#user-documentation"></a>
</h1>
<p>Documentation can be found on the <a href="https://ohdsi.github.io/Capr/" class="external-link">package website</a>.</p>
<ul>
<li>Vignette: <a href="https://ohdsi.github.io/Capr/articles/Using-Capr.html" class="external-link">Using Capr</a>
</li>
<li>Vignette: <a href="https://ohdsi.github.io/Capr/articles/Examples.html" class="external-link">Examples</a>
</li>
<li><a href="https://ohdsi.github.io/Capr/articles/capr_design.html" class="external-link">Design Document</a></li>
<li><a href="https://raw.githubusercontent.com/OHDSI/Capr/main/extras/Capr.pdf" class="external-link">Package manual</a></li>
</ul>
</div>
<div class="section level1">
<h1 id="support">Support<a class="anchor" aria-label="anchor" href="#support"></a>
</h1>
<ul>
<li>Developer questions/comments/feedback: <a href="http://forums.ohdsi.org/c/developers" class="external-link">OHDSI Forum</a>
</li>
<li>We use the <a href="https://github.com/OHDSI/Capr/issues" class="external-link">GitHub issue tracker</a> for all bugs/issues/enhancements</li>
</ul>
</div>
<div class="section level1">
<h1 id="contributing">Contributing<a class="anchor" aria-label="anchor" href="#contributing"></a>
</h1>
<p>Read <a href="https://ohdsi.github.io/Hades/contribute.html" class="external-link">here</a> how you can contribute to this package.</p>
</div>
<div class="section level1">
<h1 id="license">License<a class="anchor" aria-label="anchor" href="#license"></a>
</h1>
<p>Capr is licensed under Apache License 2.0</p>
</div>
<div class="section level1">
<h1 id="development">Development<a class="anchor" aria-label="anchor" href="#development"></a>
</h1>
<p>Capr is being developed in R Studio.</p>
</div>
<div class="section level1">
<h1 id="acknowledgements">Acknowledgements<a class="anchor" aria-label="anchor" href="#acknowledgements"></a>
</h1>
<ul>
<li>This package is maintained by Martin Lavallee and Adam Black</li>
<li>Guidance and support for the original development of Capr came from Lee Evans and LTS Computing LLC</li>
</ul>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/OHDSI/Capr/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/OHDSI/Capr/issues" class="external-link">Report a bug</a></li>
<li><a href="http://forums.ohdsi.org" class="external-link">Ask a question</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small>Apache License (&gt;= 2)</small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing Capr</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Martin Lavallee <br><small class="roles"> Author, maintainer </small>  </li>
<li>Adam Black <br><small class="roles"> Author </small>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://app.codecov.io/gh/OHDSI/Capr?branch=main" class="external-link"><img src="https://codecov.io/github/OHDSI/Capr/coverage.svg?branch=main" alt="codecov.io"></a></li>
<li><a href="https://github.com/OHDSI/Capr/actions?query=workflow%3AR-CMD-check" class="external-link"><img src="https://github.com/OHDSI/Capr/workflows/R-CMD-check/badge.svg" alt="Build Status"></a></li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Martin Lavallee, Adam Black.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
